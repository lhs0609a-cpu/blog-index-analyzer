name: Deploy Backend to AWS Lightsail

on:
  push:
    branches:
      - main
    paths:
      - 'flyio-backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Lightsail
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          command_timeout: 30m
          script: |
            # 스왑 파일 설정 (없으면 생성)
            if [ ! -f /swapfile ]; then
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "Swap file created"
            fi

            cd ~/blog-index-analyzer
            git pull origin main
            cd flyio-backend
            docker build -t blog-api .
            docker stop blog-analyzer-api || true
            docker rm blog-analyzer-api || true
            docker run -d \
              --name blog-analyzer-api \
              -p 8000:8001 \
              --env-file .env \
              --restart unless-stopped \
              --memory=1500m \
              --memory-swap=2g \
              blog-api

            # Update Caddyfile (CORS handled by FastAPI)
            sudo tee /etc/caddy/Caddyfile > /dev/null << 'CADDYEOF'
            api.blrank.co.kr {
                reverse_proxy localhost:8000
            }
            CADDYEOF

            sudo systemctl reload caddy
            echo "Deployment completed at $(date)"
