name: Deploy Backend to AWS Lightsail

on:
  push:
    branches:
      - main
    paths:
      - 'flyio-backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # 수동 실행 허용

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Lightsail
        uses: appleboy/ssh-action@v1.0.3
        env:
          NAVER_AD_CUSTOMER_ID: ${{ secrets.NAVER_AD_CUSTOMER_ID }}
          NAVER_AD_API_KEY: ${{ secrets.NAVER_AD_API_KEY }}
          NAVER_AD_SECRET_KEY: ${{ secrets.NAVER_AD_SECRET_KEY }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          command_timeout: 30m
          envs: NAVER_AD_CUSTOMER_ID,NAVER_AD_API_KEY,NAVER_AD_SECRET_KEY,NAVER_CLIENT_ID,NAVER_CLIENT_SECRET
          script: |
            # 스왑 파일 설정 (없으면 생성)
            if [ ! -f /swapfile ]; then
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "Swap file created"
            fi

            cd ~/blog-index-analyzer
            echo "=== Before fetch ==="
            git log --oneline -1
            git fetch origin main
            git reset --hard origin/main
            echo "=== After reset ==="
            git log --oneline -1
            echo "=== Check main.py deployment-test endpoint ==="
            grep "deployment-test" flyio-backend/main.py | head -5
            echo "=== Files modified ==="
            ls -la flyio-backend/main.py flyio-backend/routers/community.py
            cd flyio-backend

            # 네이버 광고 API 자격 증명을 .env에 추가/업데이트
            if [ -n "$NAVER_AD_CUSTOMER_ID" ]; then
              # 기존 값 제거 후 새 값 추가
              sed -i '/^NAVER_AD_CUSTOMER_ID=/d' .env 2>/dev/null || true
              sed -i '/^NAVER_AD_API_KEY=/d' .env 2>/dev/null || true
              sed -i '/^NAVER_AD_SECRET_KEY=/d' .env 2>/dev/null || true
              echo "NAVER_AD_CUSTOMER_ID=$NAVER_AD_CUSTOMER_ID" >> .env
              echo "NAVER_AD_API_KEY=$NAVER_AD_API_KEY" >> .env
              echo "NAVER_AD_SECRET_KEY=$NAVER_AD_SECRET_KEY" >> .env
              echo "Naver Ad API credentials updated"
            fi

            # 네이버 Open API (검색 API) 자격 증명 추가
            if [ -n "$NAVER_CLIENT_ID" ]; then
              sed -i '/^NAVER_CLIENT_ID=/d' .env 2>/dev/null || true
              sed -i '/^NAVER_CLIENT_SECRET=/d' .env 2>/dev/null || true
              echo "NAVER_CLIENT_ID=$NAVER_CLIENT_ID" >> .env
              echo "NAVER_CLIENT_SECRET=$NAVER_CLIENT_SECRET" >> .env
              echo "Naver Open API credentials updated"
            fi

            # Docker 이미지 정리 (캐시 문제 해결)
            docker stop blog-analyzer-api || true
            docker rm blog-analyzer-api || true
            docker rmi blog-api || true
            docker builder prune -f || true

            # Docker 이미지 빌드
            docker build --no-cache --pull -t blog-api .
            docker run -d \
              --name blog-analyzer-api \
              -p 8000:8000 \
              --env-file .env \
              --restart unless-stopped \
              --memory=2g \
              --memory-swap=3g \
              --shm-size=512m \
              blog-api

            # Update nginx config for api.blrank.co.kr
            sudo tee /etc/nginx/sites-available/api.blrank.co.kr > /dev/null << 'NGINXEOF'
            server {
                listen 80;
                listen [::]:80;
                server_name api.blrank.co.kr;
                return 301 https://$server_name$request_uri;
            }

            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name api.blrank.co.kr;

                ssl_certificate /etc/letsencrypt/live/api.blrank.co.kr/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/api.blrank.co.kr/privkey.pem;

                location / {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                    proxy_read_timeout 300;
                    proxy_connect_timeout 300;
                }
            }
            NGINXEOF

            # Enable site if not already enabled
            sudo ln -sf /etc/nginx/sites-available/api.blrank.co.kr /etc/nginx/sites-enabled/ || true

            # Test and reload nginx
            sudo nginx -t && sudo systemctl reload nginx || echo "nginx reload failed"

            # Also update Caddyfile as backup
            sudo tee /etc/caddy/Caddyfile > /dev/null << 'CADDYEOF'
            api.blrank.co.kr {
                reverse_proxy localhost:8000
            }
            CADDYEOF
            sudo systemctl reload caddy || true

            echo "Deployment completed at $(date)"

            # 컨테이너 내부 파일 확인
            echo "=== Container file check ==="
            sleep 10
            docker exec blog-analyzer-api cat /app/main.py | grep "deployment-test" | head -3

            # community.py 라우트 확인
            echo "=== Community routes check ==="
            docker exec blog-analyzer-api grep "reset-and-generate" /app/routers/community.py | head -2

            # API 실제 응답 확인
            echo "=== API Response Test ==="
            curl -s http://localhost:8000/deployment-test-v6 || echo "v6 test failed"
            curl -s http://localhost:8000/health || echo "Health check failed"

            # 커뮤니티 API 테스트
            echo "=== Community API test ==="
            curl -s http://localhost:8000/api/community/automation/test-v3 || echo "test-v3 failed"

            # Docker 컨테이너 로그 확인 (디버깅용)
            echo "=== Docker container logs ==="
            docker logs blog-analyzer-api --tail 50 || echo "Failed to get logs"

            # 컨테이너 상태 확인
            echo "=== Container status ==="
            docker ps -a | grep blog-analyzer-api || echo "Container not found"
