name: Deploy Backend to AWS Lightsail

on:
  push:
    branches:
      - main
    paths:
      - 'flyio-backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # 수동 실행 허용

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Lightsail
        uses: appleboy/ssh-action@v1.0.3
        env:
          NAVER_AD_CUSTOMER_ID: ${{ secrets.NAVER_AD_CUSTOMER_ID }}
          NAVER_AD_API_KEY: ${{ secrets.NAVER_AD_API_KEY }}
          NAVER_AD_SECRET_KEY: ${{ secrets.NAVER_AD_SECRET_KEY }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          command_timeout: 30m
          envs: NAVER_AD_CUSTOMER_ID,NAVER_AD_API_KEY,NAVER_AD_SECRET_KEY,NAVER_CLIENT_ID,NAVER_CLIENT_SECRET
          script: |
            # 스왑 파일 설정 (없으면 생성)
            if [ ! -f /swapfile ]; then
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "Swap file created"
            fi

            cd ~/blog-index-analyzer
            echo "=== Before fetch ==="
            git log --oneline -1
            git fetch origin main
            git reset --hard origin/main
            echo "=== After reset ==="
            git log --oneline -1
            echo "=== Check file content ==="
            grep "message" flyio-backend/services/community_automation.py | tail -3
            cd flyio-backend

            # 네이버 광고 API 자격 증명을 .env에 추가/업데이트
            if [ -n "$NAVER_AD_CUSTOMER_ID" ]; then
              # 기존 값 제거 후 새 값 추가
              sed -i '/^NAVER_AD_CUSTOMER_ID=/d' .env 2>/dev/null || true
              sed -i '/^NAVER_AD_API_KEY=/d' .env 2>/dev/null || true
              sed -i '/^NAVER_AD_SECRET_KEY=/d' .env 2>/dev/null || true
              echo "NAVER_AD_CUSTOMER_ID=$NAVER_AD_CUSTOMER_ID" >> .env
              echo "NAVER_AD_API_KEY=$NAVER_AD_API_KEY" >> .env
              echo "NAVER_AD_SECRET_KEY=$NAVER_AD_SECRET_KEY" >> .env
              echo "Naver Ad API credentials updated"
            fi

            # 네이버 Open API (검색 API) 자격 증명 추가
            if [ -n "$NAVER_CLIENT_ID" ]; then
              sed -i '/^NAVER_CLIENT_ID=/d' .env 2>/dev/null || true
              sed -i '/^NAVER_CLIENT_SECRET=/d' .env 2>/dev/null || true
              echo "NAVER_CLIENT_ID=$NAVER_CLIENT_ID" >> .env
              echo "NAVER_CLIENT_SECRET=$NAVER_CLIENT_SECRET" >> .env
              echo "Naver Open API credentials updated"
            fi

            docker build --no-cache -t blog-api .
            docker stop blog-analyzer-api || true
            docker rm blog-analyzer-api || true
            docker run -d \
              --name blog-analyzer-api \
              -p 8000:8001 \
              --env-file .env \
              --restart unless-stopped \
              --memory=2g \
              --memory-swap=3g \
              --shm-size=512m \
              blog-api

            # Update Caddyfile (CORS handled by FastAPI)
            sudo tee /etc/caddy/Caddyfile > /dev/null << 'CADDYEOF'
            api.blrank.co.kr {
                reverse_proxy localhost:8000
            }
            CADDYEOF

            sudo systemctl reload caddy
            echo "Deployment completed at $(date)"

            # 컨테이너 내부 파일 확인
            echo "=== Container file check ==="
            sleep 10
            docker exec blog-analyzer-api cat /app/services/community_automation.py | grep "message" | tail -3
